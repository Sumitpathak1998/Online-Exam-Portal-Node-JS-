<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Question List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body class="bg-light">

    <div class="container mt-5">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{Subject_name}} Question List</h5>
                <button id="addQuestion" class="btn btn-primary btn-sm">
                    <i class="bi bi-plus-circle me-1"></i> Add Question
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped mb-0 align-middle text-center">
                        <thead class="table-dark">
                            <tr>
                                <th>Sr.No</th>
                                <th>Question</th>
                                <th>Option 1</th>
                                <th>Option 2</th>
                                <th>Option 3</th>
                                <th>Option 4</th>
                                <th>Right Option</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="questionTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <button id="hiddenTrigger" type="button" data-bs-toggle="modal" data-bs-target="#mdModel" hidden></button>
    <!-- Modal -->
    <div class="modal fade" id="mdModel" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="main_content"></div>
        </div>
    </div>

    <!-- Optional: Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const getMethod = async (url) => {
            try {
                const response = await fetch(url , {
                    method : "GET"
                });
                if(!response.ok) {
                    throw new Error(await response.text());
                }
                return await response.text();
            } catch (error) {
                console.log(error);
                return error;
            }
        }

        const postMethod = async (url,param) => {
            try {
                const response = await fetch(url, {
                    method : "POST" , 
                    headers : {
                        "content-type" : "application/json"
                    },
                    body : JSON.stringify(param)
                })
                if(!response.ok) {
                    throw new Error(await response.json());
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.log(error.message);
                return error;
            }
        }

        document.addEventListener("DOMContentLoaded" , async() => {
            const subject_id = (window.location.href).split("/").filter((param) => param).pop();
            const response = await postMethod("/fetchQuestionDetails" , {subject_id});
            const tbody = document.getElementById("questionTableBody");
            tbody.innerHTML = "";
            if (response.success) {
                const data = JSON.parse(response.message);
                data.forEach((param,index) => {
                    let row = "<tr>";
                    row += `<td>${index+1}</td>`;
                    row += `<td>${param.question_details}</td>`;
                    row += `<td>${param.option_1}</td>`;
                    row += `<td>${param.option_2}</td>`;
                    row += `<td>${param.option_3}</td>`;
                    row += `<td>${param.option_4}</td>`;
                    row += `<td>${param.right_option}</td>`; 
                    row += `<td>`;
                    row += `<button id="edit_${param.id}" class="btn btn-sm btn-warning me-1" onclick = "editQuestion(this.id)"><i class="bi bi-pencil-square"></i></button>`;
                    row += `<button id="delete_${param.id}" class="btn btn-sm btn-danger" onclick = "deleteQuestion(this.id)"><i class="bi bi-trash"></i></button>`;
                    row += `</td>`;
                    row += `</tr>`;
                    tbody.insertAdjacentHTML("beforeend",row);
                });
            } else {
                let row = '<tr>';
                row += `<td colspan=8 style = "text-align:center"><b>${response.message}</b></td>`;
                row += '</tr>';
                tbody.insertAdjacentHTML("afterbegin",row);
            }
        });

        document.getElementById("addQuestion").addEventListener("click", async() => {
            const model_data = await getMethod("/getInsertAndUpdateForm");
            document.getElementById("main_content").innerHTML = model_data;
            document.getElementById("hiddenTrigger").click();
        });

        async function editQuestion(edit_button) {
            const id = edit_button.split("_")[1];
            Promise.all([getMethod(`/getInsertAndUpdateForm/${id}`),getMethod(`/question/${id}`)]).
            then(([model_data,question_data]) => {
                document.getElementById("main_content").innerHTML = model_data;
                const response = JSON.parse(question_data);
                const data = JSON.parse(response.message);
                for (const key in data[0]) {
                    if(key == "right_option") {
                        Array.from(document.getElementById(key).children).forEach((option) => {
                            if(option.value == data[0][key]) {
                                option.selected = true;
                            }
                        })
                    } else {
                        document.getElementById(key).innerHTML = data[0][key];
                    }
                }
                document.getElementById("hiddenTrigger").click();
            }).catch((error) => console.log("Error Occurred",error));
        }

        async function deleteQuestion(button_id) {
            let userResponse = confirm("Are you sure want to Remove the Question ?");
            if(userResponse) {
                const id = button_id.split("_")[1];
                const response = await postMethod("/deleteQuestion" , {id});
                alert(response.message);
            } else {
                console.log("Decline the request");
            }
        }

        async function saveOrUpdateQuestion(event) {
            let formData = new FormData(document.getElementById("question_form"));
            const finalObj = Array.from(formData.entries()).reduce((acc,[key,value]) => {
                acc[key] = value;
                return acc;
            }, {});
            if (finalObj['question_id'] == "{{question_id}}") delete finalObj.question_id;
            finalObj.subject_id = (window.location.href).split("/").filter((param) => param).pop();
            const response = await postMethod("/saveOrUpdateQuestionDetails", finalObj);
            if(response.success) {
                document.getElementById("colse_button").click();
                alert(response.message);
            } else {
                alert(response.message);
            }
        }
    </script>
</body>
</html>
