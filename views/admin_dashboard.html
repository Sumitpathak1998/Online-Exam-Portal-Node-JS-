<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Subjects</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: "Poppins", sans-serif;
        }

        .header {
            background: linear-gradient(90deg, #007bff, #00c6ff);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .header h3 {
            margin: 0;
            font-weight: 600;
        }

        .table thead {
            background-color: #007bff;
            color: white;
        }

        .table tbody tr:hover {
            background-color: #f1f9ff;
        }

        .btn-action {
            border-radius: 25px;
            font-size: 0.8rem;
            padding: 4px 10px;
        }

        .title-section {
            font-weight: 600;
            color: #495057;
            border-left: 5px solid #007bff;
            padding-left: 10px;
            margin-bottom: 15px;
        }

    </style>
</head>

<body>

    <div class="container py-4">
        
        <!-- Admin Header -->
        <div class="header d-flex justify-content-between align-items-center">
            <h3>üë®‚Äçüíº Admin: <span id="adminName">Sumit Kumar</span></h3>
            <button class="btn btn-light btn-sm">Logout</button>
        </div>

        <!-- Title -->
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="title-section">Available Subjects</h4>
            <button type="button" class="btn btn-primary btn-sm" style="margin-top: -5px;" id="add_subject">Add Subject</button>
        </div>

        <!-- Subject Table -->
        <div class="table-responsive">
            <table class="table align-middle table-bordered table-hover">
                <thead class="table-primary text-center">
                    <tr>
                        <th>Sr.No</th>
                        <th>Subject Name</th>
                        <th>Code</th>
                        <th>Max Marks</th>
                        <th>Time Duration</th>
                        <th>Total Questions</th>
                        <th>View Queations</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="subjectTable"><!-- Data dynamically added --></tbody>
            </table>
        </div>
    </div>
    <button id="hiddenTrigger" type="button" data-bs-toggle="modal" data-bs-target="#mdModel" hidden></button>
    <!-- Modal -->
    <div class="modal fade" id="mdModel" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content" id="main_content"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                let response = await fetch("/showAllSubject" , {
                    method : "GET",
                });
                if (!response.ok) {
                    throw new Error("Something went wrong");
                }
                let res = await response.json();
                const subjects = JSON.parse(res.message);
                const table = document.getElementById("subjectTable");

                subjects.forEach((sub, index) => {
                    const row = document.createElement("tr");
                    row.classList.add("text-center");
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${sub.name}</td>
                        <td>${sub.code}</td>
                        <td>${sub.max_marks}</td>
                        <td>${sub.time_duration}</td>
                        <td>${sub.num_question}</td>
                        <td>
                            <button id="${sub.id}_view_question" class="btn btn-sm btn-info" style="color:white !important;" onclick = "viewQuestion(this.id)">View</button>
                        </td>
                        <td>
                            <button id="${sub.id}_edit" class="btn btn-sm btn-warning" style="color:white !important;" onclick = "editSubject(this.id)">Edit</button>
                            <button id="${sub.id}_delete" class="btn btn-sm btn-danger" onclick = "deleteSubject(this.id)">Delete</button>
                        </td>
                    `;
                    table.appendChild(row);
                });
            } catch (error) {
                console.error(error);
            }
        })


        const getModelContent = async (url) => {
            try {
                let response = await fetch(url , {
                    method : "GET",
                });
                if (!response.ok) {
                    throw new Error(response.error);
                }
                let content = await response.text();
                return content;   
            } catch (error) {
                console.error(error);
            }
        }

        const postMethod = async (url,param) => {
            try {
                const response = await fetch(url , {
                    method : "POST" , 
                    headers : {
                        "content-type" : "application/json" 
                    },
                    body : JSON.stringify(param)
                });
                if(!response.ok) {
                    return await response.text();
                }
                const result = await response.json();
                return result;
            } catch (error) {
                console.error(error);
                return null; 
            }
        }

        document.getElementById("add_subject").addEventListener("click",async () => {
            const model_data =  await getModelContent("/insertAndUpdateSubject");
            document.getElementById("main_content").innerHTML = model_data;
            document.getElementById("hiddenTrigger").click();
        })

        async function deleteSubject(button_id) {
            let userResponse = confirm("Are you sure want to Remove the Subject?");
            if(userResponse) {
                const id = button_id.split("_")[0];
                const response = await postMethod("/deleteSubject" , {id});
                alert(response.message);
            } else {
                console.log("Decline the request");
            }
        }
        async function editSubject(button_id) {
            let id = button_id.split("_")[0];
            const model_data =  await getModelContent(`/insertAndUpdateSubject/${id}`);
            document.getElementById("main_content").innerHTML = model_data;
            const subject_id = Number (document.getElementById("subject_id").value);
            if(!isNaN(subject_id)) {
                fetch(`/subject/${subject_id}`, { 
                    method : "GET"
                }).then((res) => res.json()).then((data) => {
                    if (data.success) {
                        const subject_data = JSON.parse(data.message);
                        document.getElementById("name").value = subject_data.name;
                        document.getElementById("code").value = subject_data.code;
                        document.getElementById("max_marks").value = subject_data.max_marks;
                        document.getElementById("time_duration").value = subject_data.time_duration;
                        document.getElementById("num_question").value = subject_data.num_question;
                    } else {
                        alert(data.message);
                    }
                }).catch((error) => {
                    console.log(error);
                })
            }
            document.getElementById("hiddenTrigger").click();
        }

        function viewQuestion(view_button) {
            let [subject_id] = view_button.split("_")[0];
            window.open(`/openQuestionModel/${subject_id}`, "_blank");
        }

        async function saveOrUpdateSubject(e) {
            e.preventDefault();
            const formData = new FormData(document.getElementById("subject_form"));
            let finalObj = Array.from(formData.entries()).reduce((acc,[key,value]) => {
                acc[key] = value;
                return acc;
            }  , {});
            const sub_id = Number (finalObj.subject_id);
            if(isNaN(sub_id)) delete finalObj.subject_id;
            const response = await postMethod("/insertOrUpdateSubjectDetails" , finalObj);
            if (typeof(response) == "object") {
                document.getElementById("colse_button").click();
                alert(response.message);
            } else {
                alert(response);
            }
        }

    </script>

</body>
</html>
